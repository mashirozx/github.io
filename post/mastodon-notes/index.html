<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mastodon Notes | Mashiro&#39;s Notes</title>
<meta name="description" content="My pleasure~" />
<link rel="shortcut icon" href="https://mashiro.top/favicon.ico">
<link rel="stylesheet" href="https://mashiro.top/styles/main.css">

<script src="https://mashiro.top/media/js/jquery.min.js"></script>
<script src="https://mashiro.top/media/js/masonry.pkgd.min.js"></script>
<script src="https://mashiro.top/media/js/aos.js"></script>
<script src="https://mashiro.top/media/js/pace.min.js"></script>
<script src="https://mashiro.top/media/js/view-image.min.js"></script>
<script src="https://mashiro.top/media/js/jquery.magnific-popup.min.js"></script>
<script src="https://mashiro.top/media/js/functions.js"></script>
    <meta name="referrer" content="never">
    <meta name="description" content="Commands
docker exec -it mastodon_web_1 bash

# clean cached media files
tootctl media remove

# emoji CLI
tootctl emoji..." />
    <meta name="keywords" content="Mastodon" />
    <script src="https://mashiro.top/media/js/waterfall.min.js"></script>
    <script src="https://mashiro.top/media/js/prism.min.js"></script>
  </head>
  <body>
            <header id="header" class="grid-container">
        <!-- start: .menu-wrapper -->
        <div class="menu-mobile"> 
          <i class="fa fa-reorder"></i>
        </div>
        <div class="menu-wrapper">
          <div class="">
            <div class="logo">
              <a href="https://mashiro.top"><img src="\media\images\custom-headerLogo.png" alt=""></a>
            </div>
            <!-- start: .main-nav -->

            <nav class="main-nav grid-container grid-parent">
              <ul id="menu-header" class="menu gradient-effect">
                <li class=""><a href="https://mashiro.top" class="menu">首页</a></li>
                
                  <li class="" >
                    <a href="/" class="menu">
                      Home
                    </a>
                  </li>
                
                  <li class="" >
                    <a href="/archives" class="menu">
                      Archives
                    </a>
                  </li>
                
                  <li class="" >
                    <a href="/tags" class="menu">
                      Tags
                    </a>
                  </li>
                
                  <li class="" >
                    <a href="/post/about" class="menu">
                      About
                    </a>
                  </li>
                
                <li class="search-menu-item hide-on-mobile hide-on-tablet"><a href="#search-lightbox" class="lightbox mfp-inline"><i class="fa fa-search-line"></i></a></li>
              </ul>
            </nav>
            <a href="#search-lightbox" class="lightbox epcl-search-button mfp-inline hide-on-tablet hide-on-desktop"><i class="fa fa-search-line"></i></a>
            <!-- end: .main-nav -->
            <div class="clear"></div>
            <div class="border hide-on-tablet hide-on-mobile"></div>
          </div>    
          <div class="clear"></div>
        </div>
        <!-- end: .menu-wrapper -->
        <div class="clear"></div>
      </header>
      <div class="hide-on-mobile hide-on-tablet hide-on-desktop">
        <div id="search-lightbox" class="grid-container grid-small grid-parent mfp-hide">
          <div class="search-wrapper section">
            <form id="gridea-search-form" data-update="1603222313304" action="/search/index.html" class="search-form" _lpchecked="1">
              <input type="text" name="q" id="s" value="" class="search-field" placeholder="搜点啥..." aria-label="搜点啥..." required="">
              <button type="submit" class="submit" aria-label="Submit">
                <i class="fa fa-search-line"></i>
              </button>
            </form>
          </div>
        </div>
      </div>

      <main id="single" class="main grid-container fullcover no-sidebar aos-init aos-animate" data-aos="fade">

        <div class="center content">
          <div class="featured-image cover" style="background-image: url('https://s3-hk.2heng.xin/mstdn/static/mashiro.top/covers/2020-05-05-mastodon-notes.jpg');">
            <div class="meta top"> 
              <time class="meta-info" style="float:left;" datetime="2020-05-05"><i class="fa fa-calendar"></i><span class="lately">6 个月前</span></time>
              
              <a href="https://mashiro.top/post/mastodon-notes/#comments" class="comments meta-info" title="">
                <i class="fa fa-comment remixicon"></i><span class="comment-count valine-comment-count" data-xid="/mastodon-notes/"> </span>
              </a>
              <span id="/mastodon-notes/" class="leancloud_visitors views-counter meta-info" title=""><i class="fa fa-leancloud remixicon"></i><span class="leancloud-visitors-count"></span></span>
              
            </div>
            <div class="info">
              <div class="tags ">
                
                      <a href="https://mashiro.top/tag/m6C_vucy6/" class="ctag ctag-0 ctag-m6C_vucy6" aria-label="">Mastodon</a>
                    
              </div>
              <h1 class="title ularge white bold">Mastodon Notes</h1>
            </div>
          </div>
        </div>  

        <div class="epcl-page-wrapper">
          <div class="left-content grid-70 np-mobile">
            <article class="main-article post">
              <section class="post-content">
                <div class="text">
                  <h2 id="commands">Commands</h2>
<pre><code class="language-bash">docker exec -it mastodon_web_1 bash

# clean cached media files
tootctl media remove

# emoji CLI
tootctl emoji import ./examplr.tar.gz [--prefix PREFIX] [--suffix SUFFIX] [--overwrite] [--unlisted] [--category CATEGORY]
</code></pre>
<h2 id="external-resources">External Resources</h2>
<p>Using the admin CLI: <a href="https://docs.joinmastodon.org/admin/tootctl/">https://docs.joinmastodon.org/admin/tootctl/</a></p>
<p>The official Docker guide：<a href="https://github.com/tootsuite/documentation/blob/archive/Running-Mastodon/Docker-Guide.md">https://github.com/tootsuite/documentation/blob/archive/Running-Mastodon/Docker-Guide.md</a></p>
<p>Nginx part (Chinese): <a href="https://candinya.com/posts/mastodon-first-meet/">https://candinya.com/posts/mastodon-first-meet/</a></p>
<h2 id="docker-configurations">Docker configurations</h2>
<p>The project now includes a <code>Dockerfile</code> and a <code>docker-compose.yml</code> file (which requires at least docker-compose version <code>1.10.0</code>).</p>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>Working basic (Linux) server with Nginx (or Apache2; not officially supported).</li>
<li>Recent stable version of <a href="https://www.docker.com/community-edition">Docker</a>.</li>
<li>Recent stable version of <a href="https://github.com/docker/compose/releases/latest">Docker-compose</a>.</li>
</ul>
<h3 id="setting-up">Setting up</h3>
<p>Clone Mastodon's repository.</p>
<pre><code># Clone mastodon to ~/live directory
git clone https://github.com/tootsuite/mastodon.git live
# Change directory to ~/live
cd ~/live
# Checkout to the latest stable branch
git checkout $(git tag -l | grep -v 'rc[0-9]*$' | sort -V | tail -n 1)
</code></pre>
<p>Review the settings in <code>docker-compose.yml</code>. Note that it is <strong>not default</strong> to store the postgresql database and redis databases in a persistent storage location. If you plan on running your instance in production, you <strong>must</strong> uncomment the <a href="https://github.com/tootsuite/mastodon/blob/972f6bc861affd9bc40181492833108f905a04b6/docker-compose.yml#L7-L16"><code>volumes</code> directive</a> in <code>docker-compose.yml</code>.</p>
<h3 id="getting-the-mastodon-image">Getting the Mastodon image</h3>
<h4 id="using-a-prebuilt-image">Using a prebuilt image</h4>
<p>If you're not making any local code changes or customizations on your instance, you can use a prebuilt Docker image to avoid the time and resource consumption of a build. Images are available from Docker Hub: https://hub.docker.com/r/tootsuite/mastodon/</p>
<p>To use the prebuilt images:</p>
<ol>
<li>Open <code>docker-compose.yml</code> in your favorite text editor.
<ol>
<li>Comment out the <code>build: .</code> lines for all images (web, streaming, sidekiq).</li>
<li>Edit the <code>image: tootsuite/mastodon</code> lines for all images to include the release you want. The default is <code>latest</code> which is the most recent stable version, however it recommended to explicitly pin a version: If you wanted to use v2.2.0 for example, you would edit the lines to say: <code>image: tootsuite/mastodon:v2.2.0</code></li>
<li>Save the file and exit the text editor.</li>
</ol>
</li>
<li>Run <code>cp .env.production.sample .env.production</code> to bootstrap the configuration. You will need to edit this file later.</li>
<li>Run <code>docker-compose build</code>. It will now pull the correct image from Docker Hub.</li>
<li>Set correct file-owner with <code>chown -R 991:991 public</code></li>
</ol>
<h4 id="building-your-own-image">Building your own image</h4>
<p>You must build your own image if you've made any code modifications. To build your own image:</p>
<ol>
<li>Open <code>docker-compose.yml</code> in your favorite text editor.
<ol>
<li>Uncomment the <code>build: .</code> lines for all images (web, streaming, sidekiq) if needed.</li>
<li>Save the file and exit the text editor.</li>
</ol>
</li>
<li>Run <code>cp .env.production.sample .env.production</code> to bootstrap the configuration. You will need to edit this file later.</li>
<li>Run <code>docker-compose build</code>.</li>
<li>Set correct file-owner with <code>chown -R 991:991 public</code></li>
</ol>
<h3 id="building-the-app">Building the app</h3>
<p>Now the image can be used to generate a configuration with:</p>
<pre><code>docker-compose run --rm web bundle exec rake mastodon:setup
</code></pre>
<p>This is an interactive wizard that will guide you through the basic and necessary options and generate new app secrets. At some point it will output your configuration, copy and paste that configuration into the <code>.env.production</code> file.</p>
<p>The wizard will setup the database schema and precompile assets. After it's done, you can launch Mastodon with:</p>
<pre><code>docker-compose up -d
</code></pre>
<h3 id="configuration">Configuration</h3>
<p>Following that, make sure that you read the <a href="Production-guide.md">production guide</a>, beginning with the section that describes how to point Nginx to Mastodon.</p>
<p>The container has two volumes, for the assets and for user uploads, and optionally two more, for the postgresql and redis databases.</p>
<p>The default docker-compose.yml maps them to the repository's <code>public/assets</code> and <code>public/system</code> directories, you may wish to put them somewhere else. Likewise, the PostgreSQL and Redis images have data containers that you may wish to map somewhere where you know how to find them and back them up.</p>
<p><strong>Note</strong>: The <code>--rm</code> option for docker-compose will remove the container that is created to run a one-off command after it completes. As data is stored in volumes it is not affected by that container clean-up.</p>
<h3 id="running-tasks">Running tasks</h3>
<p>Running any of these tasks via docker-compose would look like this:</p>
<pre><code>docker-compose run --rm web bundle exec rake mastodon:media:clear
</code></pre>
<h3 id="updating">Updating</h3>
<p>This approach makes updating to the latest version a real breeze.</p>
<ol>
<li><code>git fetch</code> to download updates from the repository.</li>
<li>Now you need to tell git to use those updates. You have probably changed your <code>docker-compose.yml</code> file. Check with <code>git status</code>.</li>
</ol>
<ul>
<li>If the <code>docker-compose.yml</code> file is modified, run <code>git stash</code> to stash your changes.</li>
</ul>
<ol start="3">
<li><code>git checkout TAG_NAME</code> to use the tag code. (If you have committed changes, use <code>git merge TAG_NAME</code> instead, though this isn't likely.)</li>
<li>Only if you ran <code>git stash</code>, now run <code>git stash pop</code> to redo your changes to <code>docker-compose.yml</code>. Double check the contents of this file.</li>
<li>Build the updated Mastodon image.</li>
</ol>
<ul>
<li>If you are using a prebuilt image: First, edit the <code>image: tootsuite/mastodon</code> lines in <code>docker-compose.yml</code> to include the tag for the new version. E.g. <code>image: tootsuite/mastodon:v2.3.0</code></li>
<li>To pull the prebuilt image, or build your own from the updated code: <code>docker-compose build</code></li>
</ul>
<ol start="6">
<li>(optional) <code>docker-compose run --rm web bundle exec rake db:migrate</code> to perform database migrations. Does nothing if your database is up to date.</li>
<li>(optional) <code>docker-compose run --rm web bundle exec rake assets:precompile</code> to compile new JS and CSS assets.</li>
<li>Follow any other special instructions in the release notes.</li>
<li><code>docker-compose up -d</code> to re-create (restart) containers and pick up the changes.</li>
</ol>

                </div>
                <div class="clear"></div>
              </section>
            </article>
            <div class="clear"></div>

            <section class="related section">
              
              <article class="prev grid-50 tablet-grid-50 grid-parent">
                <div class="thumb cover lazy loaded" style="background-image: url('https://s3-hk.2heng.xin/mstdn/static/mashiro.top/covers/2020-05-05-aws-cli-notes.jpg');"></div>
                 <a href="https://mashiro.top/post/aws-cli-notes/" class="full-link"></a>
                 <div class="info">
                  <time datetime="2020-05-05">2020-05-05</time>
                  <h4 class="title white no-margin">AWS CLI Notes</h4>
                </div>
                 <span class="epcl-button red">
                  <img src="https://mashiro.top/media/images/left-arrow.svg" width="15" alt="Left Arrow">
                </span>
                <div class="overlay"></div>
              </article>
              
              
              <article class="next grid-50 tablet-grid-50 grid-parent">
                <div class="thumb cover lazy loaded" style="background-image: url('https://view.moezx.cc/images/2019/12/14/1mSE6ialQ-9TcGUz5ts_FMA.png');"></div>
                 <a href="https://mashiro.top/post/git-notes/" class="full-link"></a>
                 <div class="info">
                  <time datetime="2019-12-14">2019-12-14</time>
                  <h4 class="title white no-margin">Git Notes</h4>
                </div>
                 <span class="epcl-button red">
                  <img src="https://mashiro.top/media/images/right-arrow.svg" width="15" alt="Left Arrow">
                </span>
                <div class="overlay"></div>
              </article>
              

                <div class="clear"></div>
            </section>

              <div class="clear"></div>
              
            
              <div id="comments" class="bg-white hosted ">
                
                  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>
<div class="clear"></div>

<script>
  var gitalk = new Gitalk({
    clientID: 'a98876305cd3d78eeac4',
    clientSecret: 'e8e473c1803da7a5bf5c61be46755bd4a181c04c',
    repo: 'Comments',
    owner: 'mashirozx',
    admin: ['mashirozx'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')
</script>

                
                
              </div>
            

            </div>
          </div>
      </main>

          <footer id="footer" class="grid-container">
        <div class="widgets row gradient-effect">
            <div class="default-sidebar border-effect">
              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="tag_cloud-2" class="widget widget_epcl_posts_thumbs underline-effect">
                  <h4 class="widget-title title white bordered">最新文章</h4>
                  
                  
                  <article class="item post-0 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://mashiro.top/post/aws-cli-notes/" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('https://s3-hk.2heng.xin/mstdn/static/mashiro.top/covers/2020-05-05-aws-cli-notes.jpg');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2020-05-05">2020-05-05</time>
                      <h4 class="title usmall">
                        <a href="https://mashiro.top/post/aws-cli-notes/">AWS CLI Notes</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  <article class="item post-1 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://mashiro.top/post/mastodon-notes/" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('https://s3-hk.2heng.xin/mstdn/static/mashiro.top/covers/2020-05-05-mastodon-notes.jpg');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2020-05-05">2020-05-05</time>
                      <h4 class="title usmall">
                        <a href="https://mashiro.top/post/mastodon-notes/">Mastodon Notes</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  <article class="item post-2 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://mashiro.top/post/git-notes/" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('https://view.moezx.cc/images/2019/12/14/1mSE6ialQ-9TcGUz5ts_FMA.png');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2019-12-14">2019-12-14</time>
                      <h4 class="title usmall">
                        <a href="https://mashiro.top/post/git-notes/">Git Notes</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  <div class="clear"></div>
                </section>
              </div>

              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="tag_cloud-2" class="widget widget_tag_cloud underline-effect">
                  <h4 class="widget-title title white bordered">标签云</h4>
                  <div class="tagcloud">
                    
                      <a href="https://mashiro.top/tag/09QZMO9q0/" class="ctag ctag-0 ctag-09QZMO9q0" aria-label="">AWS</a>
                    
                      <a href="https://mashiro.top/tag/G0HMWIrLHs/" class="ctag ctag-1 ctag-G0HMWIrLHs" aria-label="">CLI</a>
                    
                      <a href="https://mashiro.top/tag/m6C_vucy6/" class="ctag ctag-2 ctag-m6C_vucy6" aria-label="">Mastodon</a>
                    
                      <a href="https://mashiro.top/tag/R_iGnb5Pq/" class="ctag ctag-3 ctag-R_iGnb5Pq" aria-label="">Git</a>
                    
                      <a href="https://mashiro.top/tag/Iln7dG6Zq/" class="ctag ctag-4 ctag-Iln7dG6Zq" aria-label="">Docker</a>
                    
                      <a href="https://mashiro.top/tag/RiHJnncHI/" class="ctag ctag-5 ctag-RiHJnncHI" aria-label="">Nginx</a>
                    
                      <a href="https://mashiro.top/tag/VkMdxo-OCk/" class="ctag ctag-6 ctag-VkMdxo-OCk" aria-label="">Linux</a>
                    
                      <a href="https://mashiro.top/tag/4lqa5YWv_/" class="ctag ctag-7 ctag-4lqa5YWv_" aria-label="">Android</a>
                    
                      <a href="https://mashiro.top/tag/-VYmSUQCv0/" class="ctag ctag-8 ctag--VYmSUQCv0" aria-label="">Kotlin</a>
                    
                      <a href="https://mashiro.top/tag/C2JHgLYXI/" class="ctag ctag-9 ctag-C2JHgLYXI" aria-label="">ZABBIX</a>
                    
                      <a href="https://mashiro.top/tag/eSdFapQDN/" class="ctag ctag-10 ctag-eSdFapQDN" aria-label="">JavaScript</a>
                    
                      <a href="https://mashiro.top/tag/aZneOexRFW/" class="ctag ctag-11 ctag-aZneOexRFW" aria-label="">Cookie</a>
                    
                      <a href="https://mashiro.top/tag/xnIhP2W461/" class="ctag ctag-12 ctag-xnIhP2W461" aria-label="">Machine Learning</a>
                    
                      <a href="https://mashiro.top/tag/L0El6szYK/" class="ctag ctag-13 ctag-L0El6szYK" aria-label="">Reading Notes</a>
                    
                      <a href="https://mashiro.top/tag/3rp8WoJoC/" class="ctag ctag-14 ctag-3rp8WoJoC" aria-label="">Gridea</a>
                    
                  </div>
                  <div class="clear"></div>
                </section>
              </div>

              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="epcl_about-2" class="widget widget_epcl_about underline-effect">
                  <h4 class="widget-title title white bordered">关于我</h4>
                  <div class="avatar">
                    <a href="" class="translate-effect thumb"><span class="fullimage cover" style="background-image: url(https://mashiro.top/images/avatar.png);"></span></a>
                  </div>
                  <div class="info">
                    <h4 class="title small author-name gradient-effect no-margin"><a href="">Mashiro&#39;s Notes</a></h4>
                    <p class="founder">My pleasure~</p>
                    <div class="social">
                      
                          
                            <a href="https://github.com/mashirozx" class="translate-effect" target="_blank"><i class="fa fa-github"></i></a>
                        
                      
                          
                            <a href="https://twitter.com/2hengxin" class="translate-effect" target="_blank"><i class="fa fa-twitter"></i></a>
                        
                      
                          
                            <a href="https://www.instagram.com/mashiro.zx/" class="translate-effect" target="_blank"><i class="fa fa-instagram"></i></a>
                        
                      
                          
                            <a href="https://2heng.xin" class="translate-effect" target="_blank"><i class="fa fa-telegram"></i></a>
                        
                      
                          
                            <a href="https://mashiro.top/atom.xml" class="translate-effect" target="_blank"><i class="fa fa-feed"></i></a>
                        
                      
                    </div> 
                  </div>
                  <div class="clear"></div>
                  </section>
              </div>

            </div>
            <div class="clear"></div>
        </div>

        <div class="logo">
          <a href="https://mashiro.top"><img src="\media\images\custom-footerLogo.png" alt=""></a>
        </div>
        <p class="published border-effect">
          ©2019 共 13 篇文章
          <br/>
          Theme <a href="https://gridea.dev/" target="_blank">「breek」</a> Powered by <a href="https://gridea.dev/" target="_blank">「Gridea」</a>
        </p>
        
        <a href="javascript:void(0)" id="back-to-top" class="epcl-button dark" style="display:none">
          <i class="fa fa-arrow"></i>
        </a>
    </footer>
    
    <div class="clear"></div>

        

      
    <script src="https://mashiro.top/media/js/functions-post.js"></script>

    </div>
    <!-- end: #wrapper -->
  </body>
</html>
